// === Audio ===
const coinSound = new Audio("sounds/coin.wav");
coinSound.volume = 0.5;

const laughSound = new Audio("sounds/baby-laugh.wav");
laughSound.volume = 0.7;

// === Game Logic ===
const Game = (() => {
  let coins = +localStorage.getItem("coins") || 0;
  let xp = +localStorage.getItem("xp") || 0;
  let level = +localStorage.getItem("level") || 1;
  const today = new Date().toLocaleDateString();

  function updateDisplay() {
    document.getElementById("coins").innerText = coins;
    document.getElementById("xp").innerText = xp;
    document.getElementById("level").innerText = level;
    document.getElementById("idr").innerText = Math.floor(coins / 100).toLocaleString("id-ID");
    updateXPBar();
    localStorage.setItem("coins", coins);
    localStorage.setItem("xp", xp);
    localStorage.setItem("level", level);
  }

  function updateXPBar() {
    const max = level * 100;
    const pct = Math.min((xp / max) * 100, 100);
    const bar = document.getElementById("xp-bar");
    bar.style.width = `${pct}%`;
    bar.setAttribute("data-percent", Math.round(pct));
  }

  function addXP(n) {
    xp += n;
    if (xp >= level * 100) {
      xp -= level * 100;
      level++;
      coins += 100;
      showLevelUp();
      dropPrize();
      showLog(`‚≠ê Naik ke Lv.${level}! +100 koin`);
    }
    updateDisplay();
  }

  function earn() {
    coins += 10;
    addXP(5);
    updateDisplay();
    showLog("+10 koin!");
    try {
      coinSound.currentTime = 0;
      coinSound.play();
    } catch {}
  }

  function cairkan() {
    const rp = Math.floor(coins / 100);
    if (rp < 1000) {
      showLog("‚ùå Belum mencapai Rp1.000");
      return;
    }
    showLog("‚úÖ Penarikan sedang diproses...");
    coins = 0;
    updateDisplay();
  }

  return {
    updateDisplay,
    earn,
    cairkan
  };
})();

// === Efek Koin Terbang ===
function spawnCoin(x, y) {
  const el = document.createElement("div");
  el.className = "coin-fly";
  el.innerText = "üí∞";
  el.style.left = x + "px";
  el.style.top = y + "px";
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1000);
}

// === Efek Sparkle ===
function createSparkle(x, y) {
  const s = document.createElement("div");
  s.className = "sparkle";
  s.style.left = x + "px";
  s.style.top = y + "px";
  document.getElementById("sparkle-container").appendChild(s);
  setTimeout(() => s.remove(), 1000);
}

// === Efek Level Up ===
function showLevelUp() {
  const el = document.createElement("div");
  el.className = "level-up-effect";
  el.innerText = "‚≠ê LEVEL UP!";
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1200);
}

// === Efek Hadiah Jatuh ===
function dropPrize() {
  const daftar = ["boneka", "botol", "mobil", "balok"];
  const src = `images/hadiah-${daftar[Math.floor(Math.random() * daftar.length)]}.png`;
  const img = document.createElement("img");
  img.src = src;
  img.className = "hadiah";
  img.style.left = Math.floor(Math.random() * 60 + 20) + "%";
  document.body.appendChild(img);
  setTimeout(() => img.remove(), 3000);
}

// === Log Pesan ===
function showLog(msg) {
  const el = document.getElementById("log");
  el.innerText = msg;
  el.classList.add("show");
  setTimeout(() => el.classList.remove("show"), 2000);
}

// === Bubble Iklan Tiap Menit ===
setInterval(() => {
  const el = document.getElementById("bubble-ad");
  if (el && el.style.display !== "block") {
    el.style.display = "block";
    el.classList.remove("anim");
    void el.offsetWidth;
    el.classList.add("anim");
    setTimeout(() => {
      el.style.display = "none";
    }, 10000);
  }
}, 60000);

// === Setup Saat Halaman Siap ===
document.addEventListener("DOMContentLoaded", () => {
  const vid = document.getElementById("baby-video");
  if (vid) {
    vid.src = "videos/baby-dance.webm";
    vid.addEventListener("click", (e) => {
      Game.earn();
      try {
        laughSound.currentTime = 0;
        laughSound.play();
      } catch {}
      spawnCoin(e.clientX, e.clientY);
      createSparkle(e.clientX, e.clientY);
    });
  }

  Game.updateDisplay();
});
